<html>
  <body>
    <form method="POST" action='picks.json' >
      <select id="week" onchange="updateCurrentWeekAndPlayer()"></select>
      <select id="player" onchange="updateCurrentWeekAndPlayer()"></select>
      <input type='submit' />
      <input type='hidden' name='hiddenpicks' id='hiddenpicks' >
      <table>
        <tr>
          <td valign="top">
            <table id="schedule" cellpadding="5" cellspacing="0"></table>
          </td>
          <td width="100"></td>
          <td valign="top">
            <table id="picks" cellpadding="5" cellspacing="0"></table>
          </td>
        </tr>
      </table>
    </form>
<script src="schedule.js"></script>
<script src="picks.js"></script>
<script>

function getCurrentWeek() {
  return 'Week' + DATA.weeks[document.getElementById('week').value].week_num;
}

function playerWeekKey() {
  var player = document.getElementById('player').value;
  var week = getCurrentWeek();
  return JSON.stringify([player, week]);
}

function getGameIndex(teamName) {
  var week = DATA.weeks[document.getElementById('week').value];
  for (var gameIndex in week.games) {
    var game = week.games[gameIndex];
    var awayTeam = DATA.teams[game[0]];
    var homeTeam = DATA.teams[game[1]];
    if (awayTeam.name === teamName || homeTeam.name === teamName) {
      return gameIndex;
    }
  }
  throw new Error("cannot find team " + teamName + " in schedule");
}

function updateCurrentWeekAndPlayer() {
  var week = DATA.weeks[document.getElementById('week').value];
  var schedule = document.getElementById('schedule');
  schedule.innerHTML = '';
  for (var gameIndex in week.games) {
    schedule.appendChild(gameRow(gameIndex));
  }
  STATE.nextPickValue = 16;
  var picks = document.getElementById('picks');
  picks.innerHTML = '';
  var playerPicks = STATE.picks[playerWeekKey()] || {"picks": []};
  for (var pickIndex in playerPicks.picks) {
    var teamName = playerPicks.picks[pickIndex];
    var gameIndex = getGameIndex(teamName);
    moveToPicksTable(gameIndex, DATA.teams[teamName]);
  }
}

function gameRow(gameIndex) {
  var week = DATA.weeks[document.getElementById('week').value];
  var game = week.games[gameIndex];
  var tr = document.createElement('tr');
  tr.setAttribute('id', 'game' + gameIndex);
  var awayTeam = DATA.teams[game[0]];
  tr.appendChild(teamImageCell(awayTeam, gameIndex, true));
  tr.appendChild(teamNameCell(awayTeam, gameIndex, true));
  var td = document.createElement('td');
  td.innerHTML = '@';
  tr.appendChild(td);
  var homeTeam = DATA.teams[game[1]];
  tr.appendChild(teamImageCell(homeTeam, gameIndex, true));
  tr.appendChild(teamNameCell(homeTeam, gameIndex, true));
  return tr;
}

function teamRow(team, gameIndex) {
  var tr = document.createElement('tr');
  var td = document.createElement('td');
  td.innerHTML = STATE.nextPickValue;
  STATE.nextPickValue -= 1;
  tr.appendChild(td);
  tr.appendChild(teamImageCell(team, gameIndex, false));
  tr.appendChild(teamNameCell(team, gameIndex, false));
  return tr;
}

function teamImageCell(team, gameIndex, isBeingPicked) {
  var td = document.createElement('td');
  var link = document.createElement('a');
  link.setAttribute('href', '#');
  link.innerHTML = '<img height="36" src="https://ssl.gstatic.com/onebox/media/sports/logos/' + team.logo + '_96x72.png">';
  link.onclick = onTeamClick(team, gameIndex, isBeingPicked);
  td.appendChild(link);
  return td;
}

function teamNameCell(team, gameIndex, isBeingPicked) {
  var td = document.createElement('td');
  var link = document.createElement('a');
  link.setAttribute('href', '#');
  link.innerHTML = team.city + '<br>' + team.name;
  link.onclick = onTeamClick(team, gameIndex, isBeingPicked);
  td.appendChild(link);
  return td;
}

function onTeamClick(team, gameIndex, isBeingPicked) {
  return function() {
    if (isBeingPicked) {
      moveToPicksTable(gameIndex, team);
      STATE.picks[playerWeekKey()] = STATE.picks[playerWeekKey()] || {
        "player": document.getElementById('player').value,
        "week": getCurrentWeek(),
        "picks": []
      };
      var player_picks = STATE.picks[playerWeekKey()];
      player_picks.picks.push(team.name);
      console.log(JSON.stringify(STATE.picks));
      document.getElementById('hiddenpicks').value = JSON.stringify(STATE.picks)
    }
    return false;
  };
}

function moveToPicksTable(gameIndex, team) {
  var picks = document.getElementById('picks');
  var game = document.getElementById('game' + gameIndex);
  game.style.display = 'none';
  picks.appendChild(teamRow(team, gameIndex));
}

window.onload = function() {
  var weekSelect = document.getElementById('week');
  for (var index in DATA.weeks) {
    var week = DATA.weeks[index];
    var option = document.createElement('option');
    option.setAttribute('value', index);
    option.innerHTML = 'Week' + week.week_num;
    weekSelect.appendChild(option);
  }
  var playerSelect = document.getElementById('player');
  for (var index in DATA.players) {
    var player = DATA.players[index];
    var option = document.createElement('option');
    option.setAttribute('value', player);
    option.innerHTML = player;
    playerSelect.appendChild(option);
  }
  updateCurrentWeekAndPlayer();
};

</script>
  </body>
</html>
